# -*- coding: utf-8 -*-
"""
/***************************************************************************
 GeoContextQGISPluginDockWidget
                                 A QGIS plugin
 QGIS plugin to connect to GeoContext
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                             -------------------
        begin                : 2021-11-22
        git sha              : $Format:%H$
        copyright            : (C) 2021 by Kartoza
        email                : divan@kartoza.com
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""

import os

from qgis.PyQt import QtGui, QtWidgets, uic
from qgis.PyQt.QtCore import pyqtSignal
from qgis.PyQt.QtWidgets import QTableWidgetItem
from qgis.core import QgsSettings

from coreapi import Client

FORM_CLASS, _ = uic.loadUiType(os.path.join(
    os.path.dirname(__file__), 'GeoContextQGISPlugin_dockwidget_base.ui'))


class GeoContextQGISPluginDockWidget(QtWidgets.QDockWidget, FORM_CLASS):

    closingPlugin = pyqtSignal()

    def __init__(self, canvas, point_tool, parent=None):
        """Constructor."""
        super(GeoContextQGISPluginDockWidget, self).__init__(parent)
        # Set up the user interface from Designer.
        # After setupUI you can access any designer object by doing
        # self.<objectname>, and you can use autoconnect slots - see
        # http://doc.qt.io/qt-5/designer-using-a-ui-file.html
        # #widgets-and-dialogs-with-auto-connect
        self.setupUi(self)

        settings = QgsSettings()
        schema = settings.value('geocontext-qgis-plugin/schema', '', type=str)
        url = settings.value('geocontext-qgis-plugin/url', '', type=str)

        self.canvas = canvas
        self.point_tool = point_tool
        self.cursor_active = True

        client = Client()
        self.document = client.get(schema)  # Retrieve the API schema
        self.list_context = client.action(document=self.document, keys=["csr", "list"])  # Get the list of context layers

        list_key_names = []
        for context in self.list_context:
            name = context['name']
            list_key_names.append(name)
        list_key_names = sorted(list_key_names)

        self.cbKey.addItems(list_key_names)
        current_name = self.cbKey.currentText()

        dict_current = self.find_name_info(current_name)

        self.tblDetails.setItem(0, 0, QtWidgets.QTableWidgetItem(dict_current['key']))
        self.tblDetails.setItem(0, 1, QtWidgets.QTableWidgetItem(dict_current['name']))
        self.tblDetails.setItem(0, 2, QtWidgets.QTableWidgetItem(dict_current['description']))

        self.cbRegistry.currentTextChanged.connect(self.registry_changed)
        self.cbKey.currentTextChanged.connect(self.key_changed)
        self.btnClear.clicked.connect(self.clear_results_table)
        self.btnFetch.clicked.connect(self.fetch_btn_click)
        self.btnCursor.clicked.connect(self.cursor_btn_click)

    def closeEvent(self, event):
        self.closingPlugin.emit()
        event.accept()

    def registry_changed(self):
        registry = self.cbRegistry.currentText()
        self.update_key_list(registry)

    def key_changed(self):
        key_name = self.cbKey.currentText()

        dict_current = self.find_name_info(key_name)

        self.tblDetails.setItem(0, 0, QtWidgets.QTableWidgetItem(dict_current['key']))
        self.tblDetails.setItem(0, 1, QtWidgets.QTableWidgetItem(dict_current['name']))
        self.tblDetails.setItem(0, 2, QtWidgets.QTableWidgetItem(dict_current['description']))

    def fetch_btn_click(self):
        x = self.lineLong.value()
        y = self.lineLat.value()

        current_key_name = self.cbKey.currentText()
        data = self.point_request_panel(x, y)

        registry = self.cbRegistry.currentText()

        if registry.lower() == 'service':
            settings = QgsSettings()
            auto_clear_table = settings.value('geocontext-qgis-plugin/auto_clear_table', False, type=bool)
            if auto_clear_table:
                self.clear_results_table()

            self.tblResult.insertRow(0)  # Always add at the top of the table
            self.tblResult.setItem(0, 0, QTableWidgetItem(current_key_name))
            self.tblResult.setItem(0, 1, QTableWidgetItem(str(data)))
        elif registry.lower() == "group":  # UPDATE
            list_groups = []
        elif registry.lower() == "collection":  # UPDATE
            list_collections = []

    def cursor_btn_click(self):
        if self.cursor_active:
            self.canvas.unsetMapTool(self.point_tool)
            self.cursor_active = False
        else:
            self.canvas.setMapTool(self.point_tool)
            self.cursor_active = True

    def point_request_panel(self, x, y):
        settings = QgsSettings()

        api_url = settings.value('geocontext-qgis-plugin/url')
        registry = (self.cbRegistry.currentText()).lower()
        key_name = self.cbKey.currentText()

        dict_key = self.find_name_info(key_name)
        key = dict_key['key']

        client = Client()
        url_request = api_url + "query?" + 'registry=' + registry + '&key=' + key + '&x=' + str(x) + '&y=' + str(y) + '&outformat=json'

        data = client.get(url_request)
        return data['value']

    def clear_results_table(self):
        row_count = self.tblResult.rowCount()
        while row_count >= 0:
            self.tblResult.removeRow(row_count)
            row_count = row_count - 1

    def find_name_info(self, search_name):
        for context in self.list_context:
            current_name = context['name']
            if current_name == search_name:
                return context
        return None

    def update_key_list(self, registry_type="service"):
        num_of_items = self.cbKey.count()
        while num_of_items >= 0:  # Clears the combobox list
            self.cbKey.removeItem(num_of_items)
            num_of_items = num_of_items - 1

        if registry_type.lower() == "service":
            settings = QgsSettings()
            schema = settings.value('geocontext-qgis-plugin/schema', '', type=str)

            client = Client()
            self.document = client.get(schema)  # Retrieve the API schema

            self.list_context = client.action(document=self.document, keys=["csr", "list"])  # Get the list of context layers

            list_key_names = []
            for context in self.list_context:
                name = context['name']
                list_key_names.append(name)
            list_key_names = sorted(list_key_names)

            self.cbKey.addItems(list_key_names)
        elif registry_type.lower() == "group":  # UPDATE
            list_groups = []
        elif registry_type.lower() == "collection":  # UPDATE
            list_collections = []
